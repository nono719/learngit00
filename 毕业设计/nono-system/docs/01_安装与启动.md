# 安装与启动指南

## 前置要求

### 必需软件
- **Go 1.19+** - [下载地址](https://golang.org/dl/)
- **Node.js 16+** - [下载地址](https://nodejs.org/)
- **PostgreSQL 15+** - [下载地址](https://www.postgresql.org/download/)
- **Redis 7+** - [下载地址](https://redis.io/download/)
- **Docker & Docker Compose** (可选，用于容器化部署) - [下载地址](https://www.docker.com/)

### 区块链环境
- **Ganache** (推荐用于开发测试) - [下载地址](https://trufflesuite.com/ganache/)
- 已部署的智能合约地址

## 快速启动（5分钟）

### 1. 启动依赖服务

```bash
# 启动PostgreSQL（使用Docker）
docker run -d --name nono-postgres \
  -e POSTGRES_DB=nono_system \
  -e POSTGRES_USER=nono \
  -e POSTGRES_PASSWORD=nono123 \
  -p 5432:5432 \
  postgres:15-alpine

# 启动Redis（使用Docker）
docker run -d --name nono-redis \
  -p 6379:6379 \
  redis:7-alpine

# 启动本地测试区块链（Ganache）
npx ganache-cli -p 8545 -d
```

### 2. 初始化数据库

```bash
# 连接PostgreSQL并创建数据库
psql -U postgres -c "CREATE DATABASE nono_system;"
psql -U postgres -c "CREATE USER nono WITH PASSWORD 'nono123';"
psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE nono_system TO nono;"
```

### 3. 配置服务

```bash
# 复制配置文件
cp config/oracle.config.example.yaml oracle/config/config.yaml
cp config/backend.config.example.yaml backend/config/config.yaml

# 注意：需要先部署智能合约并更新合约地址（参考 02_区块链配置.md）
```

### 4. 安装依赖

```bash
# Go依赖
go mod download
cd oracle && go mod download
cd ../backend && go mod download

# 前端依赖
cd ../frontend
npm install
```

### 5. 启动服务

#### 方式一：统一启动（推荐）

```bash
# 在项目根目录
go run ./cmd/startall
```

#### 方式二：分别启动（适合开发调试）

打开三个终端窗口：

**终端1 - 预言机服务：**
```bash
cd oracle
go run ./cmd/oracle
```

**终端2 - 后端API服务：**
```bash
cd backend
go run ./cmd/server
```

**终端3 - 前端应用：**
```bash
cd frontend
npm run dev
```

### 6. 访问系统

- 前端界面：http://localhost:3000
- 后端API：http://localhost:8080
- 预言机服务：http://localhost:9000

## 验证安装

### 1. 检查服务健康状态

```bash
# 后端服务
curl http://localhost:8080/health

# 预言机服务
curl http://localhost:9000/api/v1/health
```

### 2. 测试API

```bash
# 创建域
curl -X POST http://localhost:8080/api/v1/domains \
  -H "Content-Type: application/json" \
  -d '{"name": "smart_home", "description": "智能家居域"}'

# 注册设备
curl -X POST http://localhost:8080/api/v1/devices \
  -H "Content-Type: application/json" \
  -d '{
    "did": "did:example:device001",
    "device_id": "device001",
    "device_type": "sensor",
    "domain": "smart_home"
  }'
```

## 服务端口说明

- **前端应用**: 3000
- **后端API**: 8080
- **预言机服务**: 9000
- **PostgreSQL**: 5432
- **Redis**: 6379
- **区块链节点**: 8545

## 常见问题

### 问题1：端口被占用

```bash
# 查找占用端口的进程
lsof -i :8080
lsof -i :9000
lsof -i :3000

# 杀死进程
kill -9 <PID>
```

### 问题2：数据库连接失败

```bash
# 检查PostgreSQL是否运行
docker ps | grep postgres
# 或
pg_isready

# 检查连接
psql -U nono -d nono_system -h localhost
```

### 问题3：Go模块下载失败

```bash
# 设置Go代理（中国用户）
go env -w GOPROXY=https://goproxy.cn,direct
go env -w GOSUMDB=sum.golang.google.cn

# 清理模块缓存
go clean -modcache
go mod download
```

### 问题4：前端依赖安装失败

```bash
# 使用国内镜像
npm config set registry https://registry.npmmirror.com

# 清理缓存
npm cache clean --force
npm install
```

## 下一步

- 查看 [区块链配置](02_区块链配置.md) 了解如何部署智能合约
- 查看 [权限管理](04_权限管理.md) 了解用户权限系统
- 查看 [跨域认证流程](05_跨域认证流程.md) 了解系统核心功能
