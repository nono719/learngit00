# 区块链配置指南

## 概述

系统使用以太坊兼容的区块链（推荐使用Ganache进行开发测试）来存储设备身份和跨域认证记录。

## 1. Ganache配置

### 启动Ganache

1. 打开Ganache应用程序
2. 创建新工作区或使用Quickstart
3. 记录以下信息：
   - RPC Server地址（通常是 `http://127.0.0.1:8545`）
   - 第一个账户的私钥
   - 网络ID（通常是5777）

### 命令行启动

```bash
npx ganache-cli -p 8545 -d
```

## 2. 部署智能合约

### 使用Remix IDE部署（推荐）

1. **打开Remix IDE**
   - 访问 https://remix.ethereum.org

2. **创建合约文件**
   - 在`contracts`文件夹中创建`DeviceIdentity.sol`
   - 复制项目中的`contracts/DeviceIdentity.sol`内容

3. **编译合约（⚠️ 重要）**
   - **编译器版本**：选择`0.8.19`或更低版本（不要使用0.8.20+）
   - **EVM版本**：选择`london`或`istanbul`（不要使用`shanghai`或`paris`）
   - 点击"Compile DeviceIdentity.sol"

4. **部署到Ganache**
   - 切换到"Deploy & Run Transactions"标签
   - Environment: 选择"Injected Provider"或"Web3 Provider"
   - Web3 Provider Endpoint: 输入`http://127.0.0.1:8545`
   - Gas Limit: 设置为`3000000`
   - 点击"Deploy"
   - **复制合约地址**（例如：`0xCEf94E82D4252d2CC57E7B22f6e945eBB2D9C87C`）

### 常见部署错误

**错误：invalid opcode (programCounter: 19)**

**原因**：Solidity 0.8.20+使用`PUSH0`操作码，Ganache不支持

**解决方法**：
- 使用Solidity 0.8.19或更低版本
- EVM版本设置为`london`或`istanbul`

**推荐配置**：
- Solidity版本：`0.8.19`
- EVM版本：`london`
- Gas Limit：`3000000`

## 3. 配置后端连接

### 更新后端配置

编辑`backend/config/config.yaml`：

```yaml
blockchain:
  rpc_url: "http://127.0.0.1:8545"  # Ganache的RPC地址
  chain_id: 5777  # Ganache默认的链ID
  contract_addr: "0x..."  # 替换为部署的合约地址
  private_key: "your_private_key_here"  # Ganache第一个账户的私钥（不含0x前缀）
```

**重要提示**：
- `private_key`是Ganache中第一个账户的私钥
- 私钥格式：直接复制Ganache显示的私钥，去掉`0x`前缀（如果有）

### 配置预言机

编辑`oracle/config/config.yaml`：

```yaml
blockchain:
  rpc_url: "http://localhost:8545"
  chain_id: 1
  contract_addr: "0x..."  # 与后端相同的合约地址
  private_key: "0x..."  # 预言机账户私钥（需要授权为预言机）
```

**注意**：预言机账户需要在智能合约中授权为`authorizedOracle`。

## 4. 前端上链操作

### 连接Ganache

1. 打开前端应用：http://localhost:3000
2. 进入"跨域认证"页面
3. 在"区块链连接配置"中：
   - 选择"Ganache连接"标签
   - 填写RPC URL：`http://127.0.0.1:8545`
   - 填写合约地址
   - 填写私钥（去掉0x前缀）
   - 点击"连接Ganache"

### 注册设备到区块链

1. 在"设备注册"卡片中：
   - 填写设备DID
   - 可选：填写设备元数据（JSON格式）
   - 点击"注册设备到区块链"

2. **重要**：设备必须先注册到区块链，才能进行跨域认证

### 进行跨域认证

1. 切换到"前端直接上链"标签
2. 填写认证信息：
   - 设备DID（必须已注册）
   - 源域
   - 目标域
3. 点击"直接上链认证"
4. 查看交易结果（交易哈希、区块号等）

## 5. 验证交易

### 在Ganache中查看

1. 打开Ganache界面
2. 点击"Transactions"标签
3. 查看交易列表和详情

### 通过API验证

```bash
# 验证交易
curl http://localhost:8080/api/v1/auth/verify/{tx_hash}
```

### 在前端验证

1. 进入"认证验证"页面
2. 输入交易哈希或设备DID
3. 查看认证记录和交易详情

## 6. 查看区块链数据

### 使用geth控制台

```bash
# 连接到区块链节点
geth attach http://localhost:8545

# 查询交易收据
eth.getTransactionReceipt("0x交易哈希")

# 查询设备信息
# 需要调用智能合约的devices映射
```

### 使用前端区块链服务

前端提供了完整的区块链交互功能：
- 查询设备信息
- 验证交易
- 查看事件日志

## 常见问题

### 问题1：区块链连接失败

**检查项**：
- Ganache是否运行
- RPC URL是否正确
- 合约地址是否正确
- 私钥格式是否正确（去掉0x前缀）

### 问题2：交易失败

**可能原因**：
- Gas不足
- 设备未注册
- 设备状态不是Active
- 合约调用权限不足

### 问题3：前端无法连接

**解决方法**：
- 检查Ganache是否运行
- 检查RPC URL和合约地址
- 检查浏览器控制台错误信息

## 下一步

- 查看 [跨域认证流程](05_跨域认证流程.md) 了解完整认证流程
- 查看 [故障排查](07_故障排查.md) 解决常见问题
