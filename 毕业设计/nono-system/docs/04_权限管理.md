# 用户权限管理系统

## 角色定义

系统支持以下5种角色：

### 1. 系统管理员 (admin)

**权限范围**：
- ✅ 系统配置管理：新增、修改、删除和查询权限
- ✅ 域信息管理：新增、修改、删除和查询权限
- ✅ 设备身份管理：注册、更新、吊销和查询权限
- ✅ 跨域认证：发起和查询权限
- ✅ 审计功能：查询和统计权限

**数据权限**：全域数据权限（可操作所有数据）

### 2. 系统操作人员 (operator)

**权限范围**：
- ✅ 设备身份注册：新增和查询权限
- ✅ 设备身份查询：查询权限
- ✅ 跨域认证请求：发起和查询权限

**数据权限**：域级数据权限（仅可操作所属管理域内设备数据）

**要求**：必须指定所属域（domain）

### 3. 预言机节点 (oracle)

**权限范围**：
- ✅ 设备状态采集：上报权限
- ✅ 设备状态更新：更新权限
- ✅ 设备查询：查询权限（仅可查询，不可修改基础信息）

**数据权限**：受限数据权限（仅可写入设备状态数据，不可修改设备基础信息）

**要求**：必须指定所属域（domain）

### 4. 管理/审计人员 (auditor)

**权限范围**：
- ✅ 认证记录查询：查询权限
- ✅ 认证日志审计：查询和统计权限
- ✅ 系统信息查看：查询权限

**数据权限**：只读数据权限（可查询全部跨域认证记录，仅限只读访问）

### 5. 普通用户 (user)

**权限范围**：
- ✅ 系统信息查看：查询权限

**数据权限**：受限只读权限（仅可查看公开或授权的设备信息）

## 权限常量

### 设备身份管理权限
- `device:register` - 注册设备（管理员）
- `device:register:domain` - 注册设备（操作人员，域级）
- `device:update` - 更新设备
- `device:revoke` - 吊销设备
- `device:query` - 查询设备

### 跨域认证权限
- `auth:request` - 发起跨域认证
- `auth:query` - 查询认证记录

### 设备状态权限（预言机）
- `device:status:report` - 上报设备状态
- `device:status:update` - 更新设备状态

### 审计权限
- `audit:query` - 查询审计记录
- `audit:stats` - 统计权限

## API使用

### 用户注册

```bash
POST /api/v1/users/register
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123",
  "email": "admin@example.com",
  "role": "admin"
}
```

### 用户登录

```bash
POST /api/v1/users/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

响应示例：
```json
{
  "token": 1,
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "role": "admin"
  },
  "permissions": ["device:register", "device:update", ...]
}
```

### 使用Token访问API

```bash
GET /api/v1/devices
Authorization: Bearer {token}
```

## 权限控制示例

### 操作人员只能操作自己域的设备

```bash
# 操作人员注册设备（自动限制在所属域）
POST /api/v1/devices
Authorization: Bearer {operator_token}
{
  "did": "device001",
  "domain": "设备"  # 必须是操作人员所属域
}

# 操作人员无法注册其他域的设备
# 系统会自动拒绝
```

### 管理员可以操作所有域的设备

```bash
# 管理员可以注册任何域的设备
POST /api/v1/devices
Authorization: Bearer {admin_token}
{
  "did": "device001",
  "domain": "任意域"  # 可以是任何域
}
```

## 前端权限控制

前端会根据用户角色自动：
- 显示/隐藏功能菜单
- 启用/禁用操作按钮
- 过滤数据列表（操作人员只能看到自己域的设备）

## 注意事项

1. **Token格式**：系统使用用户ID作为token（简化实现）
2. **Token存储**：前端将token存储在localStorage中
3. **Token验证**：所有API请求都需要在Header中包含`Authorization: Bearer {token}`
4. **权限检查**：后端会在每个API请求中验证用户权限和数据权限

## 下一步

- 查看 [跨域认证流程](05_跨域认证流程.md) 了解系统核心功能
- 查看 [功能说明](06_功能说明.md) 了解系统其他功能
