# 预言机服务配置

## 概述

预言机服务负责从多个数据源采集设备状态，通过多数投票机制达成共识，并将共识状态更新到区块链。

## 1. 数据源配置

### 配置文件位置

`oracle/config/config.yaml`

### 配置示例

```yaml
data_sources:
  - name: "monitoring_api"
    type: "monitoring"
    url: "http://localhost:8080/api/v1/devices/status"
    api_key: "2"  # API Key（见下方获取方法）
    enabled: true
  - name: "certificate_service"
    type: "certificate"
    url: "http://localhost:8080/api/v1/devices/status"
    api_key: "2"
    enabled: true
```

### 数据源类型

- **monitoring**: 监控服务数据源
- **certificate**: 证书服务数据源
- **api**: 通用API数据源

## 2. API Key获取

### 方法1：从系统后端获取（推荐）

如果使用系统自己的后端API作为数据源，API Key就是用户登录后获得的token（用户ID）。

#### 步骤1：创建预言机专用账户

使用前端注册或API注册：

```bash
curl -X POST http://localhost:8080/api/v1/users/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "oracle_service",
    "password": "your_password",
    "email": "oracle@example.com",
    "role": "oracle",
    "domain": "your_domain"
  }'
```

#### 步骤2：登录获取Token

```bash
curl -X POST http://localhost:8080/api/v1/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "oracle_service",
    "password": "your_password"
  }'
```

响应示例：
```json
{
  "token": 2,
  "user": {
    "id": 2,
    "username": "oracle_service",
    "role": "oracle"
  }
}
```

#### 步骤3：使用Token作为API Key

将返回的`token`值（例如：`2`）作为`api_key`配置到预言机配置文件中。

### 方法2：从第三方API服务获取

根据第三方API服务的文档获取API Key，配置到`api_key`字段。

## 3. 区块链配置

### 配置示例

```yaml
blockchain:
  rpc_url: "http://localhost:8545"
  chain_id: 1
  contract_addr: "0xCEf94E82D4252d2CC57E7B22f6e945eBB2D9C87C"
  private_key: "0x6c2cd2a2e740f3b48b1316bbe2081400ff269ea3d41c5e1d47a400b0a0715127"
```

**重要**：
- 合约地址必须与后端配置相同
- 私钥对应的账户必须在智能合约中授权为`authorizedOracle`
- 私钥格式：可以包含`0x`前缀，系统会自动处理

### 授权预言机账户

在智能合约中，需要将预言机账户地址添加到`authorizedOracles`映射：

```solidity
// 在Remix中调用合约的授权函数（需要管理员权限）
authorizedOracles[oracleAddress] = true;
```

## 4. 共识机制配置

### 配置示例

```yaml
oracle:
  interval: 30  # 数据采集间隔（秒）
  voting_nodes: 3  # 投票节点数量
  min_consensus: 2  # 最小共识数量
```

### 工作原理

1. **数据采集**：每30秒从所有启用的数据源采集设备状态
2. **多数投票**：对每个设备的状态进行投票，选择出现次数最多的状态
3. **共识检查**：只有当某个状态的投票数达到`min_consensus`时，才认为达成共识
4. **区块链更新**：将共识状态更新到区块链

## 5. 前端管理界面

### 访问预言机服务页面

1. 打开前端应用：http://localhost:3000
2. 点击左侧菜单"预言机服务"

### 功能说明

- **数据源**：查看所有数据源的状态和健康检查结果
- **设备状态**：查看所有设备的共识状态
- **共识机制**：查看特定设备的投票详情
- **配置信息**：查看当前配置（合约地址、私钥、数据源等）
- **API Key管理**：注册账户、获取API Key、测试API Key

## 6. 常见问题

### 问题1：数据源显示未配置

**可能原因**：
- API Key未配置或无效
- 数据源URL不正确
- 数据源服务未运行

**解决方法**：
1. 检查`oracle/config/config.yaml`中的`api_key`配置
2. 使用前端"API Key管理"功能测试API Key
3. 检查数据源URL是否正确（应该是`http://localhost:8080/api/v1/devices/status`）
4. 确保后端服务正在运行

### 问题2：区块链连接显示未连接

**可能原因**：
- Ganache未运行
- 合约地址配置错误
- 私钥格式错误

**解决方法**：
1. 确保Ganache正在运行
2. 检查合约地址是否正确
3. 检查私钥格式（可以包含0x前缀）
4. 查看预言机服务启动日志

### 问题3：数据源健康检查失败

**可能原因**：
- API Key无效（401错误）
- 数据源URL不可访问
- 网络连接问题

**解决方法**：
1. 使用前端"API Key管理"功能测试API Key
2. 检查数据源URL是否可访问
3. 查看预言机服务日志获取详细错误信息

### 问题4：预言机服务无法启动

**检查项**：
- 配置文件格式是否正确（YAML格式）
- 数据库连接是否正常
- 区块链连接是否正常（如果配置了）

## 7. 监控和日志

### 查看服务状态

```bash
curl http://localhost:9000/api/v1/status
```

### 查看数据源状态

```bash
curl http://localhost:9000/api/v1/datasources
```

### 查看设备状态

```bash
curl http://localhost:9000/api/v1/devices/status
```

### 查看共识详情

```bash
curl http://localhost:9000/api/v1/consensus/{device_did}
```

## 下一步

- 查看 [跨域认证流程](05_跨域认证流程.md) 了解系统完整流程
- 查看 [故障排查](07_故障排查.md) 解决其他问题
