# 故障排查指南

## 1. 认证相关错误

### 401 未授权错误

**问题说明**：系统已添加权限管理功能，所有API都需要认证。

#### 快速解决方案

**方法一：使用前端登录页面（推荐）**

1. 访问登录页面：`http://localhost:3000/login`
2. 创建管理员账号（如果还没有）：
   ```bash
   curl -X POST http://localhost:8080/api/v1/users/register \
     -H "Content-Type: application/json" \
     -d '{
       "username": "admin",
       "password": "admin123",
       "email": "admin@example.com",
       "role": "admin"
     }'
   ```
3. 在登录页面输入用户名和密码登录

**方法二：使用API直接登录**

```bash
# 1. 登录获取token
curl -X POST http://localhost:8080/api/v1/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'

# 2. 使用token访问API
curl http://localhost:8080/api/v1/devices \
  -H "Authorization: Bearer {token}"
```

#### 常见问题

**Q1: 登录后仍然显示401错误**

**解决方法**：
1. 检查浏览器控制台的Network标签，查看请求头是否包含`Authorization: Bearer {token}`
2. 检查localStorage中是否有token
3. 清除localStorage并重新登录

**Q2: 无法访问登录页面**

**解决方法**：
- 直接访问：`http://localhost:3000/login`
- 检查路由配置是否正确

## 2. 预言机服务连接问题

### 404 Not Found

**问题**：无法连接到预言机服务

#### 解决方案

**1. 确保预言机服务正在运行**

```bash
# 检查端口9000是否被占用
lsof -i :9000

# 或直接测试API
curl http://localhost:9000/api/v1/health
```

**2. 重启前端服务**

**重要**：修改`vite.config.js`后必须重启前端服务！

```bash
# 停止当前前端服务（Ctrl+C）
# 然后重新启动
cd frontend
npm run dev
```

**3. 检查代理配置**

确认`frontend/vite.config.js`中的代理配置：

```javascript
'/oracle-api': {
  target: 'http://localhost:9000',
  changeOrigin: true,
  rewrite: (path) => path.replace(/^\/oracle-api/, '/api/v1'),
  secure: false,
}
```

**4. 验证代理是否工作**

在浏览器中直接访问：
```
http://localhost:3000/oracle-api/health
```

如果返回JSON数据，说明代理工作正常。

### CORS错误

**原因**：直接访问时CORS未配置

**解决**：使用Vite代理或确保预言机服务CORS已启用

### Connection Refused

**原因**：预言机服务未启动

**解决**：启动预言机服务

## 3. 区块链连接问题

### 区块链连接显示未连接

**可能原因**：
- Ganache未运行
- 合约地址配置错误
- 私钥格式错误

**解决方法**：

1. **检查Ganache是否运行**
   ```bash
   lsof -i :8545
   # 或
   curl -X POST http://localhost:8545 \
     -H "Content-Type: application/json" \
     -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'
   ```

2. **查看服务启动日志**
   - 成功：`Successfully connected to blockchain at http://localhost:8545`
   - 失败：查看具体错误信息

3. **检查配置**
   - 合约地址格式正确（42个字符，以0x开头）
   - 私钥格式正确（可以包含0x前缀，系统会自动处理）

### 交易失败

**可能原因**：
- Gas不足
- 设备未注册
- 设备状态不是Active
- 合约调用权限不足

**解决方法**：
1. 检查设备是否已注册到区块链
2. 检查设备状态是否为`active`
3. 检查账户是否有足够权限（管理员或授权账户）

## 4. 数据库连接问题

### 数据库连接失败

**检查项**：

```bash
# 检查PostgreSQL是否运行
docker ps | grep postgres
# 或
pg_isready

# 检查连接
psql -U nono -d nono_system -h localhost
```

**解决方法**：
- 确保PostgreSQL容器正在运行
- 检查数据库配置（host, port, user, password, db_name）
- 检查防火墙设置

## 5. 端口占用问题

### 端口被占用

```bash
# 查找占用端口的进程
lsof -i :8080  # 后端
lsof -i :9000  # 预言机
lsof -i :3000  # 前端
lsof -i :8545  # Ganache

# 杀死进程
kill -9 <PID>
```

## 6. 依赖安装问题

### Go模块下载失败

```bash
# 设置Go代理（中国用户）
go env -w GOPROXY=https://goproxy.cn,direct
go env -w GOSUMDB=sum.golang.google.cn

# 清理模块缓存
go clean -modcache
go mod download
```

### 前端依赖安装失败

```bash
# 使用国内镜像
npm config set registry https://registry.npmmirror.com

# 清理缓存
npm cache clean --force
npm install
```

## 7. 配置文件问题

### 配置文件格式错误

**检查项**：
- YAML格式是否正确（缩进、冒号等）
- 字段名是否正确（注意大小写）
- 字符串值是否需要引号

### 配置未生效

**解决方法**：
1. 检查配置文件路径是否正确
2. 重启服务使配置生效
3. 查看服务启动日志确认配置是否加载

## 8. 数据源配置问题

### 数据源显示未配置

**可能原因**：
- API Key未配置或无效
- 数据源URL不正确
- 数据源服务未运行

**解决方法**：
1. 检查`oracle/config/config.yaml`中的`api_key`配置
2. 使用前端"API Key管理"功能测试API Key
3. 检查数据源URL是否正确
4. 确保后端服务正在运行

### 数据源健康检查失败

**可能原因**：
- API Key无效（401错误）
- 数据源URL不可访问
- 网络连接问题

**解决方法**：
1. 使用前端"API Key管理"功能测试API Key
2. 检查数据源URL是否可访问
3. 查看预言机服务日志获取详细错误信息

## 调试技巧

### 1. 查看服务日志

- **后端服务**：查看启动终端的日志输出
- **预言机服务**：查看启动终端的日志输出
- **前端服务**：查看浏览器控制台和Vite终端日志

### 2. 使用API测试

```bash
# 测试后端健康状态
curl http://localhost:8080/health

# 测试预言机健康状态
curl http://localhost:9000/api/v1/health

# 测试区块链连接
curl -X POST http://localhost:8545 \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'
```

### 3. 检查浏览器控制台

- 打开浏览器开发者工具（F12）
- 查看Console标签的错误信息
- 查看Network标签的请求和响应

## 获取帮助

如果以上方法都无法解决问题，请：

1. 查看相关模块的详细文档
2. 检查GitHub Issues
3. 提供详细的错误日志和配置信息
